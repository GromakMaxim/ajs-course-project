!function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){},function(e,t,s){"use strict";s.r(t);s(0);class i{constructor(){return"object"==typeof i.instance||(i.instance=this),i.instance}setGameController(e){this.gameController=e}checkWinningCondition(){if(0===this.gameController.enemies.members.length){console.log("Player has won!"),this.gameController.score+=this.gameController.calculateScore();if(this.gameController.theme.next()){const e=this.gameController.theme.pointer+1;this.gameController.init(e)}else this.gameController.isBlocked=!0;return!0}return 0===this.gameController.heroes.members.length&&(console.log("Computer has won!"),this.gameController.isBlocked=!0,!0)}}class r{constructor(e,t="generic"){if(new.target===r)throw new Error("Cant create instance of Character class. Character class is abstract!");if(e<1)throw new Error("cant created Character with level "+e);this.level=e,this.attack=0,this.defence=0,this.currentHealth=50,this.maxHealth=50,this.type=t}setCurrentHealth(e){if(!(e>=0&&e<=this.maxHealth))throw new Error("the health level being set is too low");this.currentHealth=e}setMaxHealth(e){if(!(e>=0&&e>=this.currentHealth))throw new Error("the health level being set is too low");this.maxHealth=e}lvlUp(){this.increaseLvl(),this.increaseHealth(),this.increaseAttack(),this.increaseDefence()}increaseLvl(){this.level++}increaseHealth(){this.currentHealth+=80,this.currentHealth>100?(this.maxHealth=100,this.currentHealth=100):this.maxHealth=this.currentHealth}increaseAttack(){(this.maxHealth-this.currentHealth)/this.maxHealth*100<=50&&(this.attack+=.3*this.attack)}increaseDefence(){(this.maxHealth-this.currentHealth)/this.maxHealth*100<=50&&(this.defence+=.3*this.defence)}makeDamage(e,t,s){const r=Math.max(this.attack-e.character.defence,.1*this.attack);e.character.currentHealth-=r,t.showDamage(e.position,r).then(()=>{console.log(`${this.type} нанёс урон персонажу ${e.character.type}: ${r}`),e.character.currentHealth<=0&&(s.heroes.members.includes(e)?s.heroes.deleteMemberByPosition(e.position):s.enemies.members.includes(e)&&s.enemies.deleteMemberByPosition(e.position),s.allChars=s.heroes.members.concat(s.enemies.members),(new i).checkWinningCondition(),e.position===t.selectedCharacter.position&&(t.deselectCell(t.selectedCharacter.position),s.deselectAll(),t.selectedCharacter=null)),s.refresh(),s.VCChecker.checkWinningCondition()})}}class a{constructor(e,t){if(!(e instanceof r))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function n(e,t){const s=t*t-1;return 0===e?"top-left":e===s-t+1?"bottom-left":e===t-1?"top-right":e===s?"bottom-right":e>0&&e<t?"top":e>s-t?"bottom":e%t==0?"left":(e+1)%t==0?"right":"center"}class o{constructor(){this.themes=["prairie","desert","arctic","mountain"],this.pointer=0,this.isCycle=!1}setPointer(e){e>=0&&e<this.themes.length&&(this.pointer=e)}next(){return this.isCycle?(this.pointer+1<this.themes.length?this.pointer++:this.pointer=0,!0):!(this.pointer+1>this.themes.length-1)&&(this.pointer++,!0)}previous(){return this.isCycle?(this.pointer-1>=0?this.pointer--:this.pointer=this.themes.length-1,!0):this.pointer-1>=0&&(this.pointer--,!0)}getCurrentTheme(){return this.themes[this.pointer]}getThemeByIndex(e){return e>=0&&e<this.themes.length?this.themes[this.pointer]:null}}class h{constructor(e,t,s){this.members=e,this.owner=t,null!=s&&this.setPositions(s)}setPositions(e){let t;t="player"===this.owner?function(e){let t=0;const s=[];for(;s.push(t),t++,s.push(t),t+=7,!(t>=e););return s}(e):function(e){let t=6;const s=[];for(;s.push(t),t++,s.push(t),t+=7,!(t>=e););return s}(e);const s=function(e,t){const s=new Set;for(;;){const i=e[Math.floor(Math.random()*e.length)];if(s.has(i)||s.add(i),s.size===t)break}return Array.from(s)}(t,this.members.length);this.members=function(e,t){if(e.size>t.size)throw new Error("the size of the team is not equal to the number of available positions");const s=[];for(let i=0;i<e.length;i++)s.push(new a(e[i],t[i]));return s}(this.members,s)}getPositions(){return this.members.map(e=>e.position)}findMemberByPosition(e){return this.members.find(t=>t.position===e)}deleteMemberByPosition(e){this.members.splice(this.members.findIndex(t=>t.position===e),1)}lvlUp(){for(const e of this.members)e.character.lvlUp()}randomizedLvlUp(e,t){for(const s of this.members){if(Math.floor(2*Math.random())){const i=Math.floor(Math.random()*(t-e+1))+e;for(let t=e;t<i;t++)s.character.lvlUp()}}}addMember(e){if(this.getPositions().includes(e.position))throw new Error(`position ${e.position}is busy!`);this.members.push(e)}countRemainingLives(){return this.members.reduce((e,t)=>e+t.character.currentHealth,0)}}function l(e,t){if(0===e.length)throw new Error("types array is missing");const s=e[Math.floor(Math.random()*e.length)],i=s.name.toString().toLowerCase();return new s(Math.floor(Math.random()*t+1),i)}function c(e,t,s,i,r){const a=[];for(let i=0;i<s;i++){const s=l(e,t);a.push(s)}return new h(a,r,i)}class m extends r{constructor(e,t){super(e,t),this.attack=40,this.defence=10,this.movementDistance=4,this.attackDistance=1}}class d extends r{constructor(e,t){super(e,t),this.attack=25,this.defence=25,this.movementDistance=2,this.attackDistance=2}}class u extends r{constructor(e,t){super(e,t),this.attack=25,this.defence=25,this.movementDistance=2,this.attackDistance=2}}class g extends r{constructor(e,t){super(e,t),this.attack=40,this.defence=10,this.movementDistance=4,this.attackDistance=1}}class f extends r{constructor(e,t){super(e,t),this.attack=10,this.defence=40,this.movementDistance=1,this.attackDistance=4}}var p={auto:"auto",pointer:"pointer",crosshair:"crosshair",notallowed:"not-allowed"};var y={move:"move",attack:"attack"};class b{constructor(e){this.size=e,this.lineLength=Math.sqrt(e),this.field=[],this.createField(),this.column=0,this.row=0,this.value=this.field[this.row][this.column]}createField(){let e=0;const t=Math.sqrt(this.size)-1;for(let s=0;s<=t;s++){const s=[];for(let i=0;i<=t;i++)s.push(e),e++;this.field.push(s)}}getValue(){return this.field[this.row][this.column]}getCoordinates(e){for(let t=0;t<this.lineLength;t++)for(let s=0;s<this.lineLength;s++)if(this.field[t][s]===e)return[t,s];return null}setPointerByArrayArgs(e){return this.setPointer(e[0],e[1])}setPointer(e,t){return e>=0&&e<=this.lineLength-1&&t>=0&&t<=this.lineLength-1&&(this.row=e,this.column=t,!0)}setPointerByDefault(){this.row=0,this.column=0}goLeft(){return this.column-1>=0&&(this.column--,!0)}goRight(){return this.column+1<=this.lineLength-1&&(this.column++,!0)}goUp(){return this.row-1>=0&&(this.row--,!0)}goDown(){return this.row+1<=this.lineLength-1&&(this.row++,!0)}goUpLeft(){return this.row-1>=0&&this.column-1>=0&&(this.goUp(),this.goLeft(),!0)}goDownLeft(){return this.row+1<=this.lineLength-1&&this.column-1>=0&&(this.goDown(),this.goLeft(),!0)}goUpRight(){return this.row-1>=0&&this.column+1<=this.lineLength-1&&(this.goUp(),this.goRight(),!0)}goDownRight(){return this.row+1<=this.lineLength-1&&this.column+1<=this.lineLength-1&&(this.goDown(),this.goRight(),!0)}defineActionArea(e,t,s){const i=[],r=e.position;if(r>t-1||r<0)throw new Error("wrong position parameter: "+e);const a=this.getCoordinates(r);if(!this.setPointerByArrayArgs(a))throw new Error("cant define such coordinates in character "+e);let n=0;if("move"===s){n=e.character.movementDistance;let t=1;for(;t<=n;){if(!this.goUpLeft())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goUpRight())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goDownLeft())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goDownRight())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goLeft())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goRight())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goUp())break;i.push(this.getValue()),t++}for(this.setPointerByArrayArgs(a),t=1;t<=n;){if(!this.goDown())break;i.push(this.getValue()),t++}}if("attack"===s){n=e.character.attackDistance;let t,s,a=2*n+1,o=1;for(;o<=n&&(s=this.goUp(),s);)o++;1===o&&(a=n+1);let h=1;for(;h<=a;){t=this.getValue(),i.push(t);let e=1;for(;e<=n&&(s=this.goLeft(),s);)i.push(this.getValue()),e++;for(this.setPointerByArrayArgs(this.getCoordinates(t)),e=1;e<=n&&(s=this.goRight(),s);)i.push(this.getValue()),e++;if(this.setPointerByArrayArgs(this.getCoordinates(t)),s=this.goDown(),!s)break;h++}i.splice(i.findIndex(e=>e===r),1)}return i.sort((e,t)=>e-t),i}}class w{constructor(e){this.theme=e.theme.pointer,this.enemyTeam=e.enemies,this.heroesTeam=e.heroes,this.score=e.score}}class C{constructor(e,t){this.gamePlay=e,this.gameController=t,this.navigation=new b(this.gamePlay.boardSize**2)}process(){console.log("Attack selected");const e=this.gameController.heroes.getPositions();for(const t of this.gameController.enemies.members){const s=this.navigation.defineActionArea(t,this.gamePlay.boardSize**2,y.attack),i=e.filter(e=>s.includes(e));if(0!==i.length){const e=this.gameController.heroes.members.find(e=>e.position===i[0]);t.character.makeDamage(e,this.gamePlay,this.gameController);break}}console.log("Ход игрока...")}}class v{constructor(e,t){this.gamePlay=e,this.gameController=t,this.navigation=new b(this.gamePlay.boardSize**2)}process(){console.log("Defence selected")}}class P{constructor(e,t){this.gamePlay=e,this.gameController=t}analyze(){console.log("Ход компьютера... ");switch(this.findShooters()){case-1:case 0:new C(this.gamePlay,this.gameController).process();break;case 1:new v(this.gamePlay,this.gameController).process()}}findShooters(){const e=this.gameController.enemies.members.filter(e=>"vampire"===e.character.type||"daemon"===e.character.type).length,t=this.gameController.heroes.members.filter(e=>"magician"===e.character.type||"bowman"===e.character.type).length;return e>t?1:t===e?0:-1}}class L{constructor(e){this.lvl=e.level,this.attack=e.attack,this.defence=e.defence,this.currentHealth=e.currentHealth,this.maxHealth=e.maxHealth,this.pictures=["🎖","⚔","🛡","❤"]}getHint(){return`${this.pictures[0]+this.lvl+this.pictures[1]+this.attack+this.pictures[2]+this.defence+this.pictures[3]+this.currentHealth}/${this.maxHealth}`}}class k{constructor(){return"object"==typeof k.instance||(k.instance=this),k.instance}save(e){localStorage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(localStorage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}class E extends r{constructor(e,t){super(e,t),this.attack=10,this.defence=40,this.movementDistance=1,this.attackDistance=4}}const S=new class{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.selectedCharacter=null}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener("click",e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener("click",e=>this.onLoadGameClick(e)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e++){const t=document.createElement("div");t.classList.add("cell","map-tile","map-tile-"+n(e,this.boardSize)),t.addEventListener("mouseenter",e=>this.onCellEnter(e)),t.addEventListener("mouseleave",e=>this.onCellLeave(e)),t.addEventListener("click",e=>this.onCellClick(e)),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],i=document.createElement("div");i.classList.add("character",s.character.type);const r=document.createElement("div");r.classList.add("health-level");const a=document.createElement("div");a.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),a.style.width=s.character.currentHealth+"%",r.appendChild(a),i.appendChild(r),e.appendChild(i)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected","selected-"+t)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith("selected")))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise(s=>{const i=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),i.appendChild(r),r.addEventListener("animationend",()=>{i.removeChild(r),s()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}};S.bindToDOM(document.querySelector("#game-container"));const A=new k(localStorage);new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.navigation=new b(this.gamePlay.boardSize**2),this.theme=new o,this.strategyAnalyzer=new P(this.gamePlay,this),this.isBlocked=!1,this.stateService=new k,this.VCChecker=new i,this.survivors=[],this.score=0}init(e){this.gamePlay.drawUi(this.theme.getCurrentTheme()),null!=e?this.nextStage(e):(this.heroes=c([m,d],1,2,this.gamePlay.boardSize**2,"player"),this.enemies=c([g,f,u],1,2,this.gamePlay.boardSize**2,"enemy"),this.allChars=this.heroes.members.concat(this.enemies.members)),this.refresh(),this.gamePlay.addCellLeaveListener(e=>this.onCellLeave(e)),this.gamePlay.addCellEnterListener(e=>this.onCellEnter(e)),this.gamePlay.addCellClickListener(e=>this.onCellClick(e)),this.gamePlay.addNewGameListener(()=>this.init()),this.gamePlay.addSaveGameListener(()=>this.saveGame()),this.gamePlay.addLoadGameListener(()=>this.loadGame()),this.VCChecker.setGameController(this)}nextStage(e){console.log("Switching to stage "+e),this.heroes.lvlUp(),this.survivors=[];for(let t=1;t<e;t++){const t=l([m,d,E],e-1);this.survivors.push(t)}this.heroes.members.forEach(e=>this.survivors.push(e.character)),this.heroes=new h(this.survivors,"player",this.gamePlay.boardSize**2),this.enemies=c([g,f,u],1,this.heroes.members.length,this.gamePlay.boardSize**2,"enemy"),this.enemies.randomizedLvlUp(1,e),this.allChars=this.heroes.members.concat(this.enemies.members)}onCellClick(e){if(!this.isBlocked){const t=this.heroes.getPositions(),s=this.enemies.getPositions();if(t.includes(e)&&(this.heroes.members.forEach(e=>this.gamePlay.deselectCell(e.position)),this.gamePlay.selectedCharacter=this.heroes.members.find(t=>t.position===e),this.gamePlay.selectCell(e)),null!==this.gamePlay.selectedCharacter){const t=this.navigation.defineActionArea(this.gamePlay.selectedCharacter,this.gamePlay.boardSize**2,y.move),i=this.navigation.defineActionArea(this.gamePlay.selectedCharacter,this.gamePlay.boardSize**2,y.attack);if(t.includes(e)&&!s.includes(e)){const t=this.heroes.findMemberByPosition(this.gamePlay.selectedCharacter.position);t.position=e,console.log(`Игрок: переход ${t.character.type} на клетку ${e}`),this.refresh(),this.deselectAll(),this.gamePlay.selectCell(t.position),this.turn("enemy")}if(i.includes(e)&&s.includes(e)){const t=this.gamePlay.selectedCharacter.character,s=this.enemies.findMemberByPosition(e);t.makeDamage(s,this.gamePlay,this),this.turn("enemy")}}}}onCellEnter(e){if(!this.isBlocked){const t=this.heroes.getPositions(),s=this.enemies.getPositions();if(null!==this.gamePlay.selectedCharacter&&this.gamePlay.selectedCharacter.position!==e){const t=this.navigation.defineActionArea(this.gamePlay.selectedCharacter,this.gamePlay.boardSize**2,y.move);this.navigation.defineActionArea(this.gamePlay.selectedCharacter,this.gamePlay.boardSize**2,y.attack).includes(e)&&s.includes(e)?this.gamePlay.setCursor(p.crosshair):t.includes(e)&&!s.includes(e)?(this.gamePlay.setCursor(p.pointer),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor(p.notallowed)}this.getTip(e),t.includes(e)&&this.gamePlay.setCursor(p.pointer)}}onCellLeave(e){this.isBlocked||(this.gamePlay.setCursor(p.auto),null!==this.gamePlay.selectedCharacter&&this.gamePlay.selectedCharacter.position!==e&&this.gamePlay.deselectCell(e))}refresh(){this.gamePlay.redrawPositions(this.allChars)}deselectAll(){for(let e=0;e<this.gamePlay.boardSize**2;e++)this.gamePlay.selectedCharacter.position!==e&&this.gamePlay.deselectCell(e)}turn(e){w.turn=e,this.strategyAnalyzer.analyze()}getTip(e){let t=null;if(this.heroes.getPositions().includes(e)?t=this.heroes.findMemberByPosition(e):this.enemies.getPositions().includes(e)&&(t=this.enemies.findMemberByPosition(e)),null!=t){const s=new L(t.character).getHint();this.gamePlay.showCellTooltip(s,e)}}saveGame(){const e=new w(this);this.stateService.save(e)}loadGame(){const e=this.stateService.load(),t=[],s=[];for(const s of e.enemyTeam.members)t.push(this.buildCharacterFromRawData(s));for(const t of e.heroesTeam.members)s.push(this.buildCharacterFromRawData(t));this.gamePlay.drawUi(this.theme.getCurrentTheme()),this.heroes=new h(s,e.heroesTeam.owner),this.enemies=new h(t,e.enemyTeam.owner),this.allChars=this.heroes.members.concat(this.enemies.members),this.theme.setPointer(e.theme),this.refresh()}buildCharacterFromRawData(e){if(null==e)throw new Error("object is null or undefined");let t;switch(e.character.type){case"undead":t=new g(1,"undead");break;case"vampire":t=new u(1,"vampire");break;case"daemon":t=new f(1,"daemon");break;case"swordsman":t=new m(1,"swordsman");break;case"bowman":t=new d(1,"bowman");break;case"magician":t=new E(1,"magician");break;default:throw new Error("cant manage this. Unsupported type: "+e.type)}return t.attack=e.character.attack,t.defence=e.character.defence,t.attackDistance=e.character.attackDistance,t.level=e.character.level,t.maxHealth=e.character.maxHealth,t.currentHealth=e.character.currentHealth,new a(t,e.position)}calculateScore(){return this.heroes.countRemainingLives()}}(S,A).init()}]);